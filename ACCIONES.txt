[{"id":"d83c23d3.71eb8","type":"http response","z":"2da6fa43.850036","name":"RESPONSE ADD","x":735.6666259765625,"y":111.53313446044922,"wires":[]},{"id":"7db8e97f.86cfc8","type":"http in","z":"2da6fa43.850036","name":"ADD ACTION","url":"/ADD/ACTION","method":"get","swaggerDoc":"","x":131.65814208984375,"y":113.66381072998047,"wires":[["545d7e99.3b30c"]]},{"id":"545d7e99.3b30c","type":"function","z":"2da6fa43.850036","name":"Validate ADD","func":"var header = msg.req.query;\nvar stat = header.stat;\nvar code = header.code;\nvar type = header.type;\nvar descr = header.descr;\n\nvar map = {};\nmap.stat=stat;\nmap.code=code;\nmap.type=type;\nmap.descr=descr;\nmsg.payload = map;\nreturn msg;","outputs":"1","noerr":0,"x":250.663818359375,"y":65.58428192138672,"wires":[["de63b3ad.9679f"]]},{"id":"de63b3ad.9679f","type":"switch","z":"2da6fa43.850036","name":"DESICION","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"ERROR","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":365.6552734375,"y":105.84563446044922,"wires":[["325a5691.70463a"],["885f8e65.406db"]]},{"id":"3922db22.907134","type":"http in","z":"2da6fa43.850036","name":"DELETE ACTION","url":"/DELETE/ACTION","method":"post","swaggerDoc":"","x":145.70361328125,"y":237.43087005615234,"wires":[["950d578d.4b0c98"]]},{"id":"950d578d.4b0c98","type":"function","z":"2da6fa43.850036","name":"Validate DELETE","func":"var header = msg.req.headers;\nvar code = header.code;\nvar map = {};\nmap.code=code;\nif(code === undefined || code === null){\n    msg.payload = \"ERROR\";\n    msg.statusCode = 404;\n}\nelse\n    msg.payload = map;\nreturn msg;","outputs":"1","noerr":0,"x":255.70361328125,"y":184.43087005615234,"wires":[["90b6f716.d11bf8"]]},{"id":"9092b36b.5ee14","type":"neo4j","z":"2da6fa43.850036","name":"DELETE NODE","url":"http://neo4j:integradora@200.126.23.138:7474","query":"MATCH (a:Action {code:{code} })\nOPTIONAL MATCH a-[r]-()\nDELETE a, r","x":510.70361328125,"y":186.43087005615234,"wires":[["1fa33485.00cb2b"]]},{"id":"90b6f716.d11bf8","type":"switch","z":"2da6fa43.850036","name":"DESICION","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"ERROR","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":363.70361328125,"y":236.43087005615234,"wires":[["9092b36b.5ee14"],["2a895266.4c498e"]]},{"id":"ce78dea7.899ff","type":"http response","z":"2da6fa43.850036","name":"RESPONSE DELETE","x":731.70361328125,"y":235.4308853149414,"wires":[]},{"id":"2a895266.4c498e","type":"http response","z":"2da6fa43.850036","name":"ERROR DELETE","x":533.70361328125,"y":272.4308853149414,"wires":[]},{"id":"885f8e65.406db","type":"http response","z":"2da6fa43.850036","name":"ERROR ADD","x":531.70361328125,"y":137.43087005615234,"wires":[]},{"id":"1fa33485.00cb2b","type":"function","z":"2da6fa43.850036","name":"SEARCH","func":"var pay = msg.payload;\nif(pay.data.length === 0){\n    msg.statusCode = 404;\n    msg.payload=\"NOT FOUND\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":689.70361328125,"y":182.43087005615234,"wires":[["ce78dea7.899ff"]]},{"id":"325a5691.70463a","type":"neo4j","z":"2da6fa43.850036","name":"NEW NODE","url":"http://neo4j:integradora@200.126.23.138:7474","query":"CREATE(:Action {code: {code}, Status  : {stat}, Type  : {type}, Description  : {descr}})","x":531.270263671875,"y":44.23332977294922,"wires":[["d83c23d3.71eb8"]]},{"id":"dbb72525.02e538","type":"http in","z":"2da6fa43.850036","name":"INFO ACTION","url":"/INFO/ACTION","method":"get","swaggerDoc":"","x":135.70361328125,"y":382.3333206176758,"wires":[["32398109.fb3d7e"]]},{"id":"32398109.fb3d7e","type":"function","z":"2da6fa43.850036","name":"Validate INFO","func":"var parameters = msg.req.query;\nif(parameters.code === null || \n    parameters.code === undefined){\n    msg.statusCode = 404;\n    msg.payload = \"ERROR\";\n}\nelse\n    msg.payload = parameters;\nreturn msg;","outputs":"1","noerr":0,"x":228.70361328125,"y":331.3333206176758,"wires":[["1483fb88.319554"]]},{"id":"1483fb88.319554","type":"switch","z":"2da6fa43.850036","name":"DESICION","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"ERROR","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":334.70361328125,"y":379.3333206176758,"wires":[["a9db24f8.a162b8"],["7768db16.474be4"]]},{"id":"3549729d.eb280e","type":"http response","z":"2da6fa43.850036","name":"RESPONSE INFO","x":744.70361328125,"y":416.3333206176758,"wires":[]},{"id":"7768db16.474be4","type":"http response","z":"2da6fa43.850036","name":"ERROR INFO","x":501.70361328125,"y":412.3333206176758,"wires":[]},{"id":"14edf42c.89cc8c","type":"function","z":"2da6fa43.850036","name":"SEARCH","func":"var pay = msg.payload;\nif(pay.data.length === 0){\n    msg.statusCode = 404;\n    msg.payload=\"NOT FOUND\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":623.70361328125,"y":370.3333206176758,"wires":[["3549729d.eb280e","7c590188.d2f25"]]},{"id":"7c590188.d2f25","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"false","x":889.7035827636719,"y":367.569091796875,"wires":[]},{"id":"a9db24f8.a162b8","type":"neo4j","z":"2da6fa43.850036","name":"INFO NODE","url":"http://neo4j:integradora@200.126.23.138:7474","query":"MATCH (a:Action {code:{code} })\nRETURN a","x":492.70361328125,"y":324.56909942626953,"wires":[["14edf42c.89cc8c"]]},{"id":"1cf90de8.c27692","type":"http in","z":"2da6fa43.850036","name":"INFO ACTIONS BY OBJECT","url":"/INFO/ACTIONSBYOBJECT","method":"get","swaggerDoc":"","x":175.70361328125,"y":714.3333511352539,"wires":[["53a628c6.45b988"]]},{"id":"53a628c6.45b988","type":"function","z":"2da6fa43.850036","name":"Validate INFO","func":"var parameters = msg.req.query;\nif(parameters.code === null || \n    parameters.code === undefined){\n    msg.statusCode = 404;\n    msg.payload = \"ERROR\";\n}\nelse\n    msg.payload = parameters;\nreturn msg;","outputs":"1","noerr":0,"x":337.4179000854492,"y":657.8333921432495,"wires":[["4af24212.75d05c"]]},{"id":"4af24212.75d05c","type":"switch","z":"2da6fa43.850036","name":"DESICION","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"ERROR","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":443.4179000854492,"y":705.8333921432495,"wires":[["bf02b165.62b66"],["f8d5ac24.21561"]]},{"id":"45309456.2b490c","type":"http response","z":"2da6fa43.850036","name":"RESPONSE INFO","x":797.4179000854492,"y":741.8333921432495,"wires":[]},{"id":"f8d5ac24.21561","type":"http response","z":"2da6fa43.850036","name":"ERROR INFO","x":572.4179000854492,"y":751.8333921432495,"wires":[]},{"id":"728e2e80.e0c3e","type":"function","z":"2da6fa43.850036","name":"SEARCH","func":"var pay = msg.payload;\nif(pay.data.length === 0){\n    msg.statusCode = 404;\n    msg.payload=\"NOT FOUND\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":764.4179000854492,"y":652.8333921432495,"wires":[["45309456.2b490c"]]},{"id":"e7888820.ba1d08","type":"function","z":"2da6fa43.850036","name":"Validate INFO","func":"var parameters = msg.req.query;\nif(parameters.code === null || \n    parameters.code === undefined ||\n    parameters.stat === null ||\n    parameters.stat === undefined){\n        msg.statusCode = 404;\n        msg.payload = \"ERROR\";\n}\nelse\n    msg.payload = parameters;\nreturn msg;","outputs":"1","noerr":0,"x":199.85415649414062,"y":918.6041870117188,"wires":[["606fefca.fccc7","d530c931.c9a218"]]},{"id":"606fefca.fccc7","type":"switch","z":"2da6fa43.850036","name":"DESICION","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"ERROR","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":384.85418701171875,"y":860.3541870117188,"wires":[["48f1486d.fe1148","10693562.2535bb"],["f6016d27.010dd"]]},{"id":"e3f268b9.b72a08","type":"http response","z":"2da6fa43.850036","name":"RESPONSE INFO","x":957.3541717529297,"y":954.8541574478149,"wires":[]},{"id":"f6016d27.010dd","type":"http response","z":"2da6fa43.850036","name":"ERROR MODIFY","x":422.85418701171875,"y":973.8541870117188,"wires":[]},{"id":"e2dc72a9.92f9","type":"function","z":"2da6fa43.850036","name":"SEARCH","func":"var pay = msg.payload;\nif(pay.data.length === 0){\n    msg.statusCode = 404;\n    msg.payload=\"NOT FOUND\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":917.3540954589844,"y":837.8541870117188,"wires":[["e3f268b9.b72a08","b4c73756.b5dc48"]]},{"id":"5378e3cd.42277c","type":"http in","z":"2da6fa43.850036","name":"CHANGE STATE","url":"/CHANGE/STATE1","method":"get","swaggerDoc":"","x":85,"y":992.4678344726562,"wires":[["e7888820.ba1d08"]]},{"id":"48f1486d.fe1148","type":"neo4j","z":"2da6fa43.850036","name":"CASCADE_ACTIONS","url":"http://neo4j:integradora@200.126.23.138:7474","query":"MATCH (action {code:{code}})<-[:HAVE]-(object)-[:link]->(objects)-[:HAVE]->(actions) SET actions.Status={stat} RETURN actions","x":627.3909301757812,"y":889.8541870117188,"wires":[[]]},{"id":"b4c73756.b5dc48","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"payload.data[0][0].ip","x":1156.979232788086,"y":880.9438791275024,"wires":[]},{"id":"8b349ec7.7e5cc","type":"function","z":"2da6fa43.850036","name":"PREPARE TCP","func":"var pay=msg.payload;\n// var ip=pay.data[1].ip;\n// var value = pay.data[0];\n// msg.host=ip;\n// msg.port=80;\n// msg.payload=\"GET /\"+value+\" HTTP/1.1\\r\\n\\r\\n\";\n// return msg;\n\nvar ip=pay.data[0][0].ip;\nvar puerto=pay.data[0][0].puerto;\nvar value=pay.data[0][2].Status;\n\nmsg.host=ip;\nmsg.port=puerto;\nif(value==\"ON\" || value==\"OFF\"){\n    \n        msg.payload=\"GET /\"+value+\" HTTP/1.1\\r\\n\\r\\n\";\n}else {\n    var val= parseInt(value);\n    if(val<100){\n        msg.payload=\"GET /?VALUE:0\"+value+\" HTTP/1.1\\r\\n\\r\\n\";\n    }else if(val<10){\n        msg.payload=\"GET /?VALUE:00\"+value+\" HTTP/1.1\\r\\n\\r\\n\";\n    }{\n        msg.payload=\"GET /?VALUE:\"+value+\" HTTP/1.1\\r\\n\\r\\n\";\n    }\n    \n}\n\n// var j=global.get('i');\n// global.set('i',j+1);\nreturn msg;","outputs":1,"noerr":0,"x":658.2236938476562,"y":1213.5064697265625,"wires":[["121a1a8f.d569f5","76cc3ae.db432c4"]]},{"id":"121a1a8f.d569f5","type":"tcp request","z":"2da6fa43.850036","server":"","port":"","out":"time","splitc":"100","name":"TCP REQUEST","x":806.2238159179688,"y":1145.50634765625,"wires":[["638d65d3.37094c","fd6df50d.ddc6e8"]]},{"id":"fd6df50d.ddc6e8","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"true","x":1124.057113647461,"y":1211.419587135315,"wires":[]},{"id":"c566fa77.8c7bb8","type":"switch","z":"2da6fa43.850036","name":"","property":"fin","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":1007.7237243652344,"y":1025.8396921157837,"wires":[[],["fd6df50d.ddc6e8"]]},{"id":"638d65d3.37094c","type":"function","z":"2da6fa43.850036","name":"","func":"\n    msg.fin=1;\n","outputs":1,"noerr":0,"x":887.7237243652344,"y":1071.1730661392212,"wires":[["c566fa77.8c7bb8"]]},{"id":"76cc3ae.db432c4","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"true","x":835.7237548828125,"y":1272.8397216796875,"wires":[]},{"id":"d530c931.c9a218","type":"debug","z":"2da6fa43.850036","name":"le llega a change/state","active":true,"console":"false","complete":"payload","x":207.5,"y":1130.6666870117188,"wires":[]},{"id":"a37c93df.6a8c4","type":"switch","z":"2da6fa43.850036","name":"PROTOCOL","property":"payload.data[0][1].protocol","propertyType":"msg","rules":[{"t":"eq","v":"TCP","vt":"str"},{"t":"eq","v":"MQTT","vt":"str"},{"t":"eq","v":"UDP","vt":"str"},{"t":"eq","v":"SERIAL","vt":"str"}],"checkall":"true","outputs":4,"x":421,"y":1225,"wires":[["453636d0.79bb38","8b349ec7.7e5cc"],["f2dcf665.5d72f8"],[],[]]},{"id":"cd210bf5.b31078","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"false","x":721.5555114746094,"y":1030.77783203125,"wires":[]},{"id":"dcad3396.7e9ca","type":"mqtt out","z":"2da6fa43.850036","name":"cafetera","topic":"","qos":"","retain":"","broker":"f90a0618.a7d128","x":877.4443664550781,"y":1356.4443969726562,"wires":[]},{"id":"f2dcf665.5d72f8","type":"function","z":"2da6fa43.850036","name":"comunicacion mqtt","func":"var pay=msg.payload;\n\nvar topico=pay.data[0][0].ip;\nvar value=pay.data[0][2].Status;\n\n\nmsg.topic = topico;\nmsg.payload = value.toLowerCase();\nreturn msg;","outputs":1,"noerr":0,"x":622.4443054199219,"y":1329.1110229492188,"wires":[["dcad3396.7e9ca","bfeaa1a.794316"]]},{"id":"bfeaa1a.794316","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"payload","x":723.9443664550781,"y":1463.4443359375,"wires":[]},{"id":"d3854990.5be648","type":"mqtt in","z":"2da6fa43.850036","name":"cafetera","topic":"/cafetera","qos":"2","broker":"f90a0618.a7d128","x":899.9443664550781,"y":1474.4443969726562,"wires":[["18aa44d9.1f914b"]]},{"id":"18aa44d9.1f914b","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"false","x":1108.9443664550781,"y":1403.1110229492188,"wires":[]},{"id":"10693562.2535bb","type":"neo4j","z":"2da6fa43.850036","name":"MODIFY NODE V2","url":"http://neo4j:integradora@200.126.23.138:7474","query":"MATCH (a:Action { code:{code}})<-[:HAVE]-(obj)<-[:HAVE]-(dev) SET a.Status = {stat} RETURN dev,obj,a","x":654.6665954589844,"y":830.3333740234375,"wires":[["e2dc72a9.92f9","a37c93df.6a8c4","cd210bf5.b31078"]]},{"id":"371ab419.95736c","type":"http in","z":"2da6fa43.850036","name":"COMPLETE ACTION","url":"/COMPLETE/ACTION","method":"get","swaggerDoc":"","x":214.6666259765625,"y":1843.000015258789,"wires":[["7fe2c3f1.80173c"]]},{"id":"7fe2c3f1.80173c","type":"function","z":"2da6fa43.850036","name":"Validate INFO","func":"var parameters = msg.req.query;\nif(parameters.code === null || \n    parameters.code === undefined){\n    msg.statusCode = 404;\n    msg.payload = \"ERROR\";\n}\nelse\n    msg.payload = parameters;\nreturn msg;","outputs":"1","noerr":0,"x":326.6666259765625,"y":1738,"wires":[["df1ebacd.296928"]]},{"id":"df1ebacd.296928","type":"switch","z":"2da6fa43.850036","name":"DESICION","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"ERROR","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":432.6666259765625,"y":1786,"wires":[["10ced5bc.1e402a"],["72d45373.a2bf3c"]]},{"id":"fb969b46.517a78","type":"http response","z":"2da6fa43.850036","name":"RESPONSE INFO","x":786.6666259765625,"y":1822,"wires":[]},{"id":"72d45373.a2bf3c","type":"http response","z":"2da6fa43.850036","name":"ERROR INFO","x":578.6666412353516,"y":1840.000015258789,"wires":[]},{"id":"92b7325b.2356d","type":"function","z":"2da6fa43.850036","name":"SEARCH","func":"var pay = msg.payload;\nif(pay.data.length === 0){\n    msg.statusCode = 404;\n    msg.payload=\"NOT FOUND\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":712.6665954589844,"y":1768.000015258789,"wires":[["fb969b46.517a78"]]},{"id":"80f8e944.52b178","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"payload","x":884.6211853027344,"y":1734.2357940673828,"wires":[]},{"id":"10ced5bc.1e402a","type":"neo4j","z":"2da6fa43.850036","name":"COMPLETE ACTION","url":"http://neo4j:integradora@200.126.23.138:7474","query":"match(device)-[:HAVE]->(object)-[:HAVE]->(action {code:{code}}) return device,object,action","x":588.6666259765625,"y":1705,"wires":[["932fb0f.255715","ae3fe2ce.fa378","92b7325b.2356d","80f8e944.52b178"]]},{"id":"856661d2.b3aef","type":"http in","z":"2da6fa43.850036","name":"DELETE COMPLETE ACTION","url":"/DELETE/COMPLETE/ACTION","method":"get","swaggerDoc":"","x":163.66665649414062,"y":2045,"wires":[["cd1194c1.123738"]]},{"id":"cd1194c1.123738","type":"function","z":"2da6fa43.850036","name":"Validate DELETE","func":"var header = msg.req.query;\nvar code = header.code;\nvar map = {};\nmap.code=code;\nif(code === undefined || code === null){\n    msg.payload = \"ERROR\";\n    msg.statusCode = 404;\n}\nelse\n    msg.payload = map;\nreturn msg;","outputs":"1","noerr":0,"x":291.6666488647461,"y":1930.9997634887695,"wires":[["3f56efcc.14c1b"]]},{"id":"3f56efcc.14c1b","type":"switch","z":"2da6fa43.850036","name":"DESICION","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"ERROR","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":395.6666488647461,"y":2000.9997634887695,"wires":[["7df96cf9.95c264"],["a2d0f161.c0254"]]},{"id":"7178e3f9.238d3c","type":"http response","z":"2da6fa43.850036","name":"RESPONSE DELETE","x":850.666633605957,"y":2024.9997787475586,"wires":[]},{"id":"a2d0f161.c0254","type":"http response","z":"2da6fa43.850036","name":"ERROR DELETE","x":581.6666488647461,"y":2032.9997634887695,"wires":[]},{"id":"8eb61ce.23330e","type":"function","z":"2da6fa43.850036","name":"SEARCH","func":"\nreturn msg;","outputs":1,"noerr":0,"x":886.666633605957,"y":1935.9997787475586,"wires":[["7178e3f9.238d3c"]]},{"id":"7df96cf9.95c264","type":"neo4j","z":"2da6fa43.850036","name":"DELETE NODE COMPLETE ACTION","url":"http://neo4j:integradora@200.126.23.138:7474","query":"MATCH (a:Device) MATCH (a)-[r]->(b:Object) MATCH (b)-[r1]->(c:Action {code:{code} }) delete c,r1","x":628.6665954589844,"y":1933.33349609375,"wires":[["8eb61ce.23330e"]]},{"id":"8ae79359.d06e7","type":"http in","z":"2da6fa43.850036","name":"MODIFY ACTION","url":"/MODIFY/ACTIONEDIT","method":"get","swaggerDoc":"","x":194.765625,"y":2194.25,"wires":[["99fdba0e.488698"]]},{"id":"99fdba0e.488698","type":"function","z":"2da6fa43.850036","name":"Validate INFO","func":"var parameters = msg.req.query;\nif(parameters.code === null || \n    parameters.code === undefined){\n    msg.statusCode = 404;\n    msg.payload = \"ERROR\";\n}\nelse\n    msg.payload = parameters;\nreturn msg;","outputs":"1","noerr":0,"x":277.765625,"y":2143.25,"wires":[["7e0f632c.9fcdbc"]]},{"id":"7e0f632c.9fcdbc","type":"switch","z":"2da6fa43.850036","name":"DESICION","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"ERROR","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":387.76560974121094,"y":2196.25,"wires":[["92efa556.8d1048"],["8147a9e8.6c9208"]]},{"id":"123b6db7.557702","type":"http response","z":"2da6fa43.850036","name":"RESPONSE INFO","x":826.7655944824219,"y":2235.25,"wires":[]},{"id":"8147a9e8.6c9208","type":"http response","z":"2da6fa43.850036","name":"ERROR INFO","x":545.7655944824219,"y":2250.25,"wires":[]},{"id":"c4b8dd5d.8bfc8","type":"function","z":"2da6fa43.850036","name":"SEARCH","func":"var pay = msg.payload;\nif(pay.data.length === 0){\n    msg.statusCode = 404;\n    msg.payload=\"NOT FOUND\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":730.7655944824219,"y":2151.25,"wires":[["123b6db7.557702"]]},{"id":"92efa556.8d1048","type":"neo4j","z":"2da6fa43.850036","name":"MODIFY ACTION","url":"http://neo4j:integradora@200.126.23.138:7474","query":"MATCH (a:Action {code:{code} }) SET a.Type = {type}, a.Description = {description} RETURN a","x":547.765625,"y":2143.25,"wires":[["c4b8dd5d.8bfc8"]]},{"id":"bf02b165.62b66","type":"neo4j","z":"2da6fa43.850036","name":"ACTIONS_BY_OBJECT","url":"http://neo4j:integradora@200.126.23.138:7474","query":"MATCH (o:Object{code:{code}}) OPTIONAL MATCH (o)-[:HAVE]->(action) RETURN action","x":594.6665649414062,"y":599,"wires":[["728e2e80.e0c3e"]]},{"id":"2f5b2880.6b0438","type":"function","z":"2da6fa43.850036","name":"Validate INFO","func":"var parameters = msg.req.query;\nif(parameters.code === null || \n    parameters.code === undefined ||\n    parameters.stat === null ||\n    parameters.stat === undefined){\n        msg.statusCode = 404;\n        msg.payload = \"ERROR\";\n}\nelse\n    msg.payload = parameters;\nreturn msg;","outputs":"1","noerr":0,"x":199.85415649414062,"y":2405,"wires":[["a70239d.5dabdc8","dfd0bef7.baf42"]]},{"id":"a70239d.5dabdc8","type":"switch","z":"2da6fa43.850036","name":"DESICION","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"ERROR","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":384.85418701171875,"y":2346.75,"wires":[["eee962ed.6ed29","336e6a56.55d4c6"],["d07edba8.4c4598"]]},{"id":"87bc86b.9a36778","type":"http response","z":"2da6fa43.850036","name":"RESPONSE INFO","x":957.3541717529297,"y":2441.249970436096,"wires":[]},{"id":"d07edba8.4c4598","type":"http response","z":"2da6fa43.850036","name":"ERROR MODIFY","x":574.8541564941406,"y":2406.25,"wires":[]},{"id":"b562fbd8.d45478","type":"function","z":"2da6fa43.850036","name":"SEARCH","func":"var pay = msg.payload;\nif(pay.data.length === 0){\n    msg.statusCode = 404;\n    msg.payload=\"NOT FOUND\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":917.3540954589844,"y":2324.25,"wires":[["87bc86b.9a36778","1a00f7d2.e54098"]]},{"id":"3c9d0730.9d2ce8","type":"http in","z":"2da6fa43.850036","name":"CHANGE STATE","url":"/CHANGE/STATE","method":"get","swaggerDoc":"","x":85,"y":2478.8636474609375,"wires":[["2f5b2880.6b0438"]]},{"id":"1a00f7d2.e54098","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"payload.data[0][0].ip","x":1156.979232788086,"y":2367.3396921157837,"wires":[]},{"id":"81a6c6d.ba1c938","type":"function","z":"2da6fa43.850036","name":"PREPARE TCP","func":"var pay=msg.payload;\n// var ip=pay.data[1].ip;\n// var value = pay.data[0];\n// msg.host=ip;\n// msg.port=80;\n// msg.payload=\"GET /\"+value+\" HTTP/1.1\\r\\n\\r\\n\";\n// return msg;\n\nvar ip=pay.data[0][0].ip;\nvar puerto=pay.data[0][0].puerto;\nvar value=pay.data[0][2].Status;\n\nmsg.host=ip;\nmsg.port=puerto;\nif(value==\"ON\" || value==\"OFF\"){\n    \n        msg.payload=\"GET /\"+value+\" HTTP/1.1\\r\\n\\r\\n\";\n}else {\n    var val= parseInt(value);\n    if(val<100){\n        msg.payload=\"GET /?VALUE:0\"+value+\" HTTP/1.1\\r\\n\\r\\n\";\n    }else if(val<10){\n        msg.payload=\"GET /?VALUE:00\"+value+\" HTTP/1.1\\r\\n\\r\\n\";\n    }{\n        msg.payload=\"GET /?VALUE:\"+value+\" HTTP/1.1\\r\\n\\r\\n\";\n    }\n    \n}\n\n// var j=global.get('i');\n// global.set('i',j+1);\nreturn msg;","outputs":1,"noerr":0,"x":657.2236633300781,"y":2698.90234375,"wires":[["971c4350.bfb6d","c4de55fb.249438"]]},{"id":"971c4350.bfb6d","type":"tcp request","z":"2da6fa43.850036","server":"","port":"","out":"time","splitc":"100","name":"TCP REQUEST","x":806.2238159179688,"y":2631.9021606445312,"wires":[["6e2efb32.aae014","dd34dce0.88eeb"]]},{"id":"dd34dce0.88eeb","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"true","x":1124.057113647461,"y":2697.815400123596,"wires":[]},{"id":"a134ced5.0ae87","type":"switch","z":"2da6fa43.850036","name":"","property":"fin","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":1007.7237243652344,"y":2512.235505104065,"wires":[[],["dd34dce0.88eeb"]]},{"id":"6e2efb32.aae014","type":"function","z":"2da6fa43.850036","name":"","func":"\n    msg.fin=1;\n","outputs":1,"noerr":0,"x":887.7237243652344,"y":2557.5688791275024,"wires":[["a134ced5.0ae87"]]},{"id":"c4de55fb.249438","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"true","x":835.7237548828125,"y":2759.2355346679688,"wires":[]},{"id":"dfd0bef7.baf42","type":"debug","z":"2da6fa43.850036","name":"le llega a change/state","active":true,"console":"false","complete":"payload","x":207.5,"y":2617.0625,"wires":[]},{"id":"84d17ab2.b45628","type":"switch","z":"2da6fa43.850036","name":"PROTOCOL","property":"payload.data[0][1].protocol","propertyType":"msg","rules":[{"t":"eq","v":"TCP","vt":"str"},{"t":"eq","v":"MQTT","vt":"str"},{"t":"eq","v":"UDP","vt":"str"},{"t":"eq","v":"SERIAL","vt":"str"}],"checkall":"true","outputs":4,"x":473,"y":2607.395751953125,"wires":[["453636d0.79bb38","81a6c6d.ba1c938"],["67118a82.0adbe4"],[],[]]},{"id":"68b6008a.64de3","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"false","x":721.5555114746094,"y":2517.1736450195312,"wires":[]},{"id":"d8a0a65.e295b58","type":"mqtt out","z":"2da6fa43.850036","name":"cafetera","topic":"","qos":"","retain":"","broker":"f90a0618.a7d128","x":877.4443664550781,"y":2842.8402099609375,"wires":[]},{"id":"67118a82.0adbe4","type":"function","z":"2da6fa43.850036","name":"comunicacion mqtt","func":"var pay=msg.payload;\n\nvar topico=pay.data[0][0].ip;\nvar value=pay.data[0][2].Status;\n\n\nmsg.topic = topico;\nmsg.payload = value.toLowerCase();\nreturn msg;","outputs":1,"noerr":0,"x":622.4443054199219,"y":2815.5068359375,"wires":[["d8a0a65.e295b58","da97050b.39fb78"]]},{"id":"da97050b.39fb78","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"payload","x":723.9443664550781,"y":2949.8401489257812,"wires":[]},{"id":"8430ea36.ac8ac8","type":"mqtt in","z":"2da6fa43.850036","name":"cafetera","topic":"/cafetera","qos":"2","broker":"f90a0618.a7d128","x":899.9443664550781,"y":2960.8402099609375,"wires":[["ef54a57c.52ef08"]]},{"id":"ef54a57c.52ef08","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"false","x":1108.9443664550781,"y":2889.5068359375,"wires":[]},{"id":"eee962ed.6ed29","type":"neo4j","z":"2da6fa43.850036","name":"MODIFY NODE V2","url":"http://neo4j:integradora@200.126.23.138:7474","query":"MATCH (a:Action { code:{code}})<-[:HAVE]-(obj)<-[:HAVE]-(dev) SET a.Status = {stat} RETURN dev,obj,a","x":654.6665954589844,"y":2316.7291870117188,"wires":[["b562fbd8.d45478","84d17ab2.b45628","68b6008a.64de3"]]},{"id":"1850c932.810ed7","type":"function","z":"2da6fa43.850036","name":"PREPARE TCP","func":"var pay=msg.payload;\nvar ip=pay.data[0][0].ip;\nvar puerto=pay.data[0][0].puerto;\nvar value=pay.data[0][1].Status;\nmsg.host=ip;\nmsg.port=puerto;\nmsg.payload=\"GET /\"+value+\" HTTP/1.1\\r\\n\\r\\n\";\nvar j=global.get('i');\nglobal.set('i',j+1);\nreturn msg;","outputs":1,"noerr":0,"x":460.6666564941406,"y":3308.666748046875,"wires":[["428f8434.55ba7c","16875be7.128074"]]},{"id":"428f8434.55ba7c","type":"tcp request","z":"2da6fa43.850036","server":"","port":"","out":"time","splitc":"100","name":"TCP REQUEST","x":674.6667175292969,"y":3264.666717529297,"wires":[["d1768051.13cc"]]},{"id":"bce40d4.ae352f","type":"function","z":"2da6fa43.850036","name":"TO MSG.PAYLOAD","func":"var map={};\nmap.code=msg.payload.code;\nmsg.payload=map\nreturn msg;","outputs":1,"noerr":0,"x":387.49652099609375,"y":3383.329833984375,"wires":[["5c331b90.a57cc4"]]},{"id":"d4890ff1.c6c88","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"true","x":1126.5001220703125,"y":3310.5799560546875,"wires":[]},{"id":"8d3dabab.5834c8","type":"switch","z":"2da6fa43.850036","name":"","property":"fin","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":901.166748046875,"y":3222,"wires":[["916e62a7.476e6"],["d4890ff1.c6c88"]]},{"id":"d1768051.13cc","type":"function","z":"2da6fa43.850036","name":"","func":"var i=global.get('i');\nvar tam=global.get('tam');\nif(i==tam)\n    msg.fin=0;\nelse\n    msg.fin=1;\nreturn msg;","outputs":1,"noerr":0,"x":981.166748046875,"y":3406.3333435058594,"wires":[["8d3dabab.5834c8"]]},{"id":"16875be7.128074","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"true","x":749.1667175292969,"y":3332.0000610351562,"wires":[]},{"id":"b9277ef3.9a384","type":"mqtt out","z":"2da6fa43.850036","name":"cafetera","topic":"","qos":"","retain":"","broker":"f90a0618.a7d128","x":604.666748046875,"y":3566.3418579101562,"wires":[]},{"id":"bec076b9.3cb7e8","type":"function","z":"2da6fa43.850036","name":"comunicacion mqtt","func":"var pay=msg.payload;\n\nvar topico=pay.data[0][0].ip;\nvar value=pay.data[0][2].Status;\n\n\nmsg.topic = topico;\nmsg.payload = value.toLowerCase();\nreturn msg;","outputs":1,"noerr":0,"x":367.6667175292969,"y":3537.0084838867188,"wires":[["b9277ef3.9a384","65bcf341.d90d4c","d1768051.13cc"]]},{"id":"65bcf341.d90d4c","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"payload","x":456.16668701171875,"y":3627.3418579101562,"wires":[]},{"id":"4620914c.f7259","type":"mqtt in","z":"2da6fa43.850036","name":"cafetera","topic":"/cafetera","qos":"2","broker":"f90a0618.a7d128","x":634.166748046875,"y":3623.3419189453125,"wires":[["9a24abb3.9d85b8"]]},{"id":"9a24abb3.9d85b8","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"false","x":828.166748046875,"y":3612.0084533691406,"wires":[]},{"id":"c5c0d6dd.5e4f58","type":"switch","z":"2da6fa43.850036","name":"PROTOCOL","property":"payload.protocol","propertyType":"msg","rules":[{"t":"eq","v":"TCP","vt":"str"},{"t":"eq","v":"MQTT","vt":"str"}],"checkall":"true","outputs":2,"x":164.66680908203125,"y":3313.6666564941406,"wires":[["bce40d4.ae352f"],["bec076b9.3cb7e8"]]},{"id":"222a2a19.cc4876","type":"function","z":"2da6fa43.850036","name":"GLOBAL INFORMATION","func":"var pay2= msg.payload;\nglobal.set('i',0);\nglobal.set('tam',pay2.data.length);\nglobal.set('pay',pay2);\nreturn msg;","outputs":1,"noerr":0,"x":672.5034790039062,"y":3039.21533203125,"wires":[["916e62a7.476e6","dfff85d3.90f728"]]},{"id":"916e62a7.476e6","type":"function","z":"2da6fa43.850036","name":"RECORRIDO","func":"var TAM=global.get('tam');\nvar i=global.get('i');\nvar pay=global.get('pay');\nmsg.payload=pay.data[i];\nreturn msg","outputs":"1","noerr":0,"x":894.666748046875,"y":3084.666648864746,"wires":[["c5c0d6dd.5e4f58"]]},{"id":"653321fe.22337","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"true","x":298.5,"y":2985,"wires":[]},{"id":"6300e77d.c0a438","type":"switch","z":"2da6fa43.850036","name":"desicion tam","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","outputs":2,"x":434.5,"y":2930,"wires":[["222a2a19.cc4876"],["a175c855.181658"]]},{"id":"a175c855.181658","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"true","x":479.6666564941406,"y":3134.33349609375,"wires":[]},{"id":"336e6a56.55d4c6","type":"neo4j","z":"2da6fa43.850036","name":"CASCADE_ACTIONS","url":"http://neo4j:integradora@200.126.23.138:7474","query":"MATCH (action {code:{code}})<-[:HAVE]-(o:Object) OPTIONAL MATCH (o)-[:link]->(o1:Object) OPTIONAL MATCH (o1)-[:HAVE]->(actions)  SET actions.Status={stat} RETURN o1","x":273.6666564941406,"y":2748.33349609375,"wires":[["653321fe.22337","6300e77d.c0a438"]]},{"id":"dfff85d3.90f728","type":"debug","z":"2da6fa43.850036","name":"","active":true,"console":"false","complete":"true","x":1089.6665954589844,"y":3052.666748046875,"wires":[]},{"id":"5c331b90.a57cc4","type":"neo4j","z":"2da6fa43.850036","name":"VERIFY ACTION","url":"http://neo4j:integradora@200.126.23.138:7474","query":"MATCH (d:Device)-[r]->(o:Object{code:{code}}) OPTIONAL MATCH (o)-[:HAVE]-(a:Action) RETURN d,a","x":603.6665954589844,"y":3392.33349609375,"wires":[["1850c932.810ed7"]]},{"id":"f90a0618.a7d128","type":"mqtt-broker","z":"","broker":"m10.cloudmqtt.com","port":"18485","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""}]